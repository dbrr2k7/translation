{% extends "task-info.html" %}

{% block btn-content %}
    <button class="btn btn-default" onclick="send_data({{ taskId }})">Save</button>

    <hr>
    <label for="change_log">Change Log: </label>
    <input id="change_log" type="text" name="change_log">
    <button class="btn btn-default" onclick="publishLastVersion({{ taskId }})">Publish Last Version</button>

{% endblock %}

{% block script-content %}

    <script type="text/javascript">
        var last_saved_content;
        $(document).ready(function(){
            last_saved_content = simplemde.value();
        });
        function send_data(quesId) {
            var mycontent = simplemde.value();
            if(mycontent == last_saved_content){
                // TODO: Beautify this alert
                alert("There is no change");
                return;
            }

            var data = {
                'title': document.getElementById('title').value,
                'content': mycontent,
                'id': quesId,
                csrfmiddlewaretoken: '{{ csrf_token }}'
            };

            $.ajax({
                url: " {% url 'savetask' %}",
                data: data,
                type: "POST",
                success: function (response) {
                    last_saved_content = mycontent;
                    ToastrUtil.success('Successfully Saved ...');
                },
                complete: function () {
                },
                error: function (xhr, textStatus, thrownError) {
                // TODO: should raise Error toastr
                }
            });
            return false;
        }
        function publishLastVersion(questionId) {
            var mycontent = simplemde.value();
            if(mycontent != last_saved_content){
                // TODO: Beautify this alert
                alert("There is some change you should save");
                return;
            }
            var change_log = $.trim($('#change_log').val());
            if(change_log == ""){
                // TODO: Beautify this alert
                alert("Change Log can't be empty");
                return;
            }
            $.ajax({
                url: " {% url 'publishtask' %}",
                data: {
                    'id': questionId,
                    'is_published': 'True',
                    'change_log': change_log,
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                type: "POST",
                success: function (response) {
                    $('#change_log').val("");
                    ToastrUtil.success('Successfully Published...');
                },
                complete: function () {
                },
                error: function (xhr, textStatus, thrownError) {
                }
            });
        }
    </script>
{% endblock %}