{% extends "base.html" %}

{% block content %}

    <div class="container">
        <div class="col-sm-12">
            <div class="panel panel-default">
                <div class="panel-body">
                    <form action="{%  url 'task' %}" method="post">
                        {% csrf_token %}
                        <label for="task_title">Title: </label>
                        <input id="task_title" type="text" name="title">
                        <select name="contest">
                             {% for contest in contests %}
                             <option value="{{contest.id}}">{{contest.title}}</option>
                             {% endfor %}

                        </select>
                        <input type="submit" value="New Task">
                    </form>

                </div>
            </div>
        </div>


        <div class="col-sm-12">
            <div class="panel panel-default">
                <div class="panel-body">

                    <table class="table">
                        <thead><tr>
                            <th>Main Question</th>
                            <th>Contest</th>
                            <th>Publish</th>
                        </tr></thead>
                        <tbody>
                        {% for task in tasks %}
                            <tr>
                                <td><a href="{% url 'edittask' contest_slug=task.contest_slug task_title=task.title %}">{{ task.title }}</a></td>
                                <td>{{task.contest}}</td>
                                <td id="td_{{ task.id }}">
                                    {% if not task.enabled and task.can_enable %}

                                        <button  onclick="enableTask({{ task.id }})">
                                            Enable Task
                                        </button>
                                    {% endif %}
                                    {% if task.enabled%}
                                        <button  onclick="disableTask({{ task.id }})">
                                            Disable Task
                                        </button>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>

                </div>
            </div>
        </div>
    </div>

    <script>
        function getCookie(name) {
          var value = "; " + document.cookie;
          var parts = value.split("; " + name + "=");
          if (parts.length == 2) return parts.pop().split(";").shift();
        }
        function enableTask(questionId) {
            $.ajax({
                url: " {% url 'enabletask' %}",
                data: {
                    'id': questionId,
                    csrfmiddlewaretoken: getCookie("csrftoken")
                },
                type: "POST",
                success: function (response) {
                    location.reload();
                    // TODO: should be more asynchron :(
                    /*if (publishing == 'False')
                        $('#td_' + questionId).html('<button onclick="changePublishing(' + questionId + ', \'True\')"> UnPublish </button>');
                    else
                        $('#td_' + questionId).html('<button onclick="changePublishing(' + questionId + ', \'False\')"> Publish </button>');

                    */
                    }
                ,
                complete: function () {
                },
                error: function (xhr, textStatus, thrownError) {
                }
            });
        }
        function disableTask(questionId) {
            $.ajax({
                url: " {% url 'enabletask' %}" + '?' + $.param({"id": questionId}),
                data: {
                    'id': questionId,
                },

                beforeSend: function(xhr) {
                    xhr.setRequestHeader("X-CSRFToken", getCookie("csrftoken"));
                },
                type: "DELETE",
                success: function (response) {
                    location.reload();
                    // TODO: should be more asynchron :(
                    /*if (publishing == 'False')
                        $('#td_' + questionId).html('<button onclick="changePublishing(' + questionId + ', \'True\')"> UnPublish </button>');
                    else
                        $('#td_' + questionId).html('<button onclick="changePublishing(' + questionId + ', \'False\')"> Publish </button>');

                    */
                    }
                ,
                complete: function () {
                },
                error: function (xhr, textStatus, thrownError) {
                }
            });
        }

    </script>

{% endblock %}